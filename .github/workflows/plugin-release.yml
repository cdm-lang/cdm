name: Plugin Release

on:
  push:
    tags:
      - 'cdm-plugin-*-v*.*.*'

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    name: Create Plugin Release
    runs-on: ubuntu-latest
    outputs:
      plugin_name: ${{ steps.plugin_metadata.outputs.plugin_shortname }}
      plugin_full_name: ${{ steps.tag_info.outputs.plugin_name }}
      version: ${{ steps.plugin_metadata.outputs.version }}
      description: ${{ steps.plugin_metadata.outputs.description }}
      docs_url: ${{ steps.plugin_metadata.outputs.docs }}
      wasm_url: ${{ steps.plugin_metadata.outputs.wasm_url }}
      checksum: ${{ steps.plugin_metadata.outputs.checksum }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract plugin info from tag
        id: tag_info
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # Extract plugin name (e.g., cdm-plugin-docs from cdm-plugin-docs-v0.1.0)
          PLUGIN_NAME=$(echo $TAG | sed -E 's/-v[0-9]+\.[0-9]+\.[0-9]+$//')
          echo "plugin_name=$PLUGIN_NAME" >> $GITHUB_OUTPUT

          # Extract version (e.g., v0.1.0 from cdm-plugin-docs-v0.1.0)
          VERSION=$(echo $TAG | sed -E 's/.*(-v[0-9]+\.[0-9]+\.[0-9]+)$/\1/' | sed 's/^-//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Convert plugin name to crate name (replace hyphens with underscores)
          CRATE_NAME=$(echo $PLUGIN_NAME | sed 's/-/_/g')
          echo "crate_name=$CRATE_NAME" >> $GITHUB_OUTPUT

          echo "Releasing $PLUGIN_NAME $VERSION (crate: $CRATE_NAME)"

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: wasm32-wasip1

      - name: Build plugin
        working-directory: crates/${{ steps.tag_info.outputs.plugin_name }}
        run: |
          cargo build --release --target wasm32-wasip1 --target-dir target

      - name: Generate checksum
        working-directory: crates/${{ steps.tag_info.outputs.plugin_name }}
        run: |
          WASM_FILE="target/wasm32-wasip1/release/${{ steps.tag_info.outputs.crate_name }}.wasm"
          shasum -a 256 $WASM_FILE | awk '{print $1}' > $WASM_FILE.sha256
          echo "Checksum: $(cat $WASM_FILE.sha256)"

      - name: Extract plugin metadata
        id: plugin_metadata
        run: |
          # Read plugin metadata
          PLUGIN_JSON="crates/${{ steps.tag_info.outputs.plugin_name }}/cdm-plugin.json"
          PLUGIN_SHORTNAME=$(jq -r '.name' "$PLUGIN_JSON")
          DESCRIPTION=$(jq -r '.description' "$PLUGIN_JSON")
          DOCS=$(jq -r '.docs // empty' "$PLUGIN_JSON")
          CHECKSUM=$(cat crates/${{ steps.tag_info.outputs.plugin_name }}/target/wasm32-wasip1/release/${{ steps.tag_info.outputs.crate_name }}.wasm.sha256)

          # Extract version without 'v' prefix
          VERSION="${{ steps.tag_info.outputs.version }}"
          VERSION="${VERSION#v}"

          # Construct WASM URL
          WASM_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.tag_info.outputs.tag }}/${{ steps.tag_info.outputs.crate_name }}.wasm"

          echo "plugin_shortname=$PLUGIN_SHORTNAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "docs=$DOCS" >> $GITHUB_OUTPUT
          echo "wasm_url=$WASM_URL" >> $GITHUB_OUTPUT
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT

          echo "Plugin metadata extracted:"
          echo "  Name: $PLUGIN_SHORTNAME"
          echo "  Version: $VERSION"
          echo "  URL: $WASM_URL"
          echo "  Checksum: $CHECKSUM"
          echo "  Docs: $DOCS"

      - name: Create release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          # ${{ steps.tag_info.outputs.plugin_name }} ${{ steps.tag_info.outputs.version }}

          ## Installation

          Download the WASM file and verify its integrity:

          ```bash
          # Download the plugin
          curl -LO https://github.com/${{ github.repository }}/releases/download/${{ steps.tag_info.outputs.tag }}/${{ steps.tag_info.outputs.crate_name }}.wasm

          # Download the checksum
          curl -LO https://github.com/${{ github.repository }}/releases/download/${{ steps.tag_info.outputs.tag }}/${{ steps.tag_info.outputs.crate_name }}.wasm.sha256

          # Verify the checksum
          echo "$(cat ${{ steps.tag_info.outputs.crate_name }}.wasm.sha256)  ${{ steps.tag_info.outputs.crate_name }}.wasm" | shasum -a 256 -c
          ```

          ## Checksum

          SHA256: `$(cat crates/${{ steps.tag_info.outputs.plugin_name }}/target/wasm32-wasip1/release/${{ steps.tag_info.outputs.crate_name }}.wasm.sha256)`

          ## Plugin Info

          - **Plugin Name**: ${{ steps.tag_info.outputs.plugin_name }}
          - **Version**: ${{ steps.tag_info.outputs.version }}
          - **WASM Target**: wasm32-wasip1
          EOF

          echo "Release notes created"

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag_info.outputs.tag }}
          name: ${{ steps.tag_info.outputs.plugin_name }} ${{ steps.tag_info.outputs.version }}
          body_path: release_notes.md
          files: |
            crates/${{ steps.tag_info.outputs.plugin_name }}/target/wasm32-wasip1/release/${{ steps.tag_info.outputs.crate_name }}.wasm
            crates/${{ steps.tag_info.outputs.plugin_name }}/target/wasm32-wasip1/release/${{ steps.tag_info.outputs.crate_name }}.wasm.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-registry:
    name: Update Registry
    needs: release
    uses: ./.github/workflows/update-plugin-registry.yml
    with:
      plugin_name: ${{ needs.release.outputs.plugin_name }}
      plugin_full_name: ${{ needs.release.outputs.plugin_full_name }}
      version: ${{ needs.release.outputs.version }}
      description: ${{ needs.release.outputs.description }}
      docs_url: ${{ needs.release.outputs.docs_url }}
      wasm_url: ${{ needs.release.outputs.wasm_url }}
      checksum: ${{ needs.release.outputs.checksum }}
