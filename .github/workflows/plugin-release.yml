name: Plugin Release

on:
  push:
    tags:
      - 'cdm-plugin-*-v*.*.*'

permissions:
  contents: write

jobs:
  release:
    name: Create Plugin Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract plugin info from tag
        id: tag_info
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # Extract plugin name (e.g., cdm-plugin-docs from cdm-plugin-docs-v0.1.0)
          PLUGIN_NAME=$(echo $TAG | sed -E 's/-v[0-9]+\.[0-9]+\.[0-9]+$//')
          echo "plugin_name=$PLUGIN_NAME" >> $GITHUB_OUTPUT

          # Extract version (e.g., v0.1.0 from cdm-plugin-docs-v0.1.0)
          VERSION=$(echo $TAG | sed -E 's/.*(-v[0-9]+\.[0-9]+\.[0-9]+)$/\1/' | sed 's/^-//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Convert plugin name to crate name (replace hyphens with underscores)
          CRATE_NAME=$(echo $PLUGIN_NAME | sed 's/-/_/g')
          echo "crate_name=$CRATE_NAME" >> $GITHUB_OUTPUT

          echo "Releasing $PLUGIN_NAME $VERSION (crate: $CRATE_NAME)"

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: wasm32-wasip1

      - name: Build plugin
        working-directory: crates/${{ steps.tag_info.outputs.plugin_name }}
        run: |
          cargo build --release --target wasm32-wasip1 --target-dir target

      - name: Generate checksum
        working-directory: crates/${{ steps.tag_info.outputs.plugin_name }}
        run: |
          WASM_FILE="target/wasm32-wasip1/release/${{ steps.tag_info.outputs.crate_name }}.wasm"
          shasum -a 256 $WASM_FILE | awk '{print $1}' > $WASM_FILE.sha256
          echo "Checksum: $(cat $WASM_FILE.sha256)"

      - name: Create release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          # ${{ steps.tag_info.outputs.plugin_name }} ${{ steps.tag_info.outputs.version }}

          ## Installation

          Download the WASM file and verify its integrity:

          ```bash
          # Download the plugin
          curl -LO https://github.com/${{ github.repository }}/releases/download/${{ steps.tag_info.outputs.tag }}/${{ steps.tag_info.outputs.crate_name }}.wasm

          # Download the checksum
          curl -LO https://github.com/${{ github.repository }}/releases/download/${{ steps.tag_info.outputs.tag }}/${{ steps.tag_info.outputs.crate_name }}.wasm.sha256

          # Verify the checksum
          echo "$(cat ${{ steps.tag_info.outputs.crate_name }}.wasm.sha256)  ${{ steps.tag_info.outputs.crate_name }}.wasm" | shasum -a 256 -c
          ```

          ## Checksum

          SHA256: `$(cat crates/${{ steps.tag_info.outputs.plugin_name }}/target/wasm32-wasip1/release/${{ steps.tag_info.outputs.crate_name }}.wasm.sha256)`

          ## Plugin Info

          - **Plugin Name**: ${{ steps.tag_info.outputs.plugin_name }}
          - **Version**: ${{ steps.tag_info.outputs.version }}
          - **WASM Target**: wasm32-wasip1
          EOF

          echo "Release notes created"

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag_info.outputs.tag }}
          name: ${{ steps.tag_info.outputs.plugin_name }} ${{ steps.tag_info.outputs.version }}
          body_path: release_notes.md
          files: |
            crates/${{ steps.tag_info.outputs.plugin_name }}/target/wasm32-wasip1/release/${{ steps.tag_info.outputs.crate_name }}.wasm
            crates/${{ steps.tag_info.outputs.plugin_name }}/target/wasm32-wasip1/release/${{ steps.tag_info.outputs.crate_name }}.wasm.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update registry.json
        id: update_registry
        run: |
          # Read plugin metadata
          PLUGIN_JSON="crates/${{ steps.tag_info.outputs.plugin_name }}/cdm-plugin.json"
          PLUGIN_SHORTNAME=$(jq -r '.name' "$PLUGIN_JSON")
          DESCRIPTION=$(jq -r '.description' "$PLUGIN_JSON")
          CHECKSUM=$(cat crates/${{ steps.tag_info.outputs.plugin_name }}/target/wasm32-wasip1/release/${{ steps.tag_info.outputs.crate_name }}.wasm.sha256)

          # Extract version without 'v' prefix
          VERSION="${{ steps.tag_info.outputs.version }}"
          VERSION="${VERSION#v}"

          # Construct WASM URL
          WASM_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.tag_info.outputs.tag }}/${{ steps.tag_info.outputs.crate_name }}.wasm"

          echo "Updating registry for plugin: $PLUGIN_SHORTNAME"
          echo "Version: $VERSION"
          echo "URL: $WASM_URL"
          echo "Checksum: $CHECKSUM"

          # Update registry.json using jq
          jq --arg name "$PLUGIN_SHORTNAME" \
             --arg version "$VERSION" \
             --arg desc "$DESCRIPTION" \
             --arg url "$WASM_URL" \
             --arg checksum "sha256:$CHECKSUM" \
             --arg repo "git:https://github.com/${{ github.repository }}.git" \
             --arg updated "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
             '
             .updated_at = $updated |
             .plugins[$name] = {
               description: $desc,
               repository: $repo,
               official: true,
               versions: ((.plugins[$name].versions // {}) + {
                 ($version): {
                   wasm_url: $url,
                   checksum: $checksum
                 }
               }),
               latest: $version
             }
             ' registry.json > registry.json.tmp

          mv registry.json.tmp registry.json

          echo "Registry updated successfully"

      - name: Create Pull Request for registry update
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update registry: ${{ steps.tag_info.outputs.plugin_name }} ${{ steps.tag_info.outputs.version }}"
          branch: registry-update-${{ steps.tag_info.outputs.tag }}
          base: main
          delete-branch: true
          title: "Update registry: ${{ steps.tag_info.outputs.plugin_name }} ${{ steps.tag_info.outputs.version }}"
          body: |
            This PR automatically updates the plugin registry for the release of **${{ steps.tag_info.outputs.plugin_name }} ${{ steps.tag_info.outputs.version }}**.

            ## Changes
            - Updated registry.json with new version information
            - WASM URL: `https://github.com/${{ github.repository }}/releases/download/${{ steps.tag_info.outputs.tag }}/${{ steps.tag_info.outputs.crate_name }}.wasm`
            - Checksum: `sha256:$(cat crates/${{ steps.tag_info.outputs.plugin_name }}/target/wasm32-wasip1/release/${{ steps.tag_info.outputs.crate_name }}.wasm.sha256)`

            This PR was automatically created by the plugin release workflow.

            Related release: [${{ steps.tag_info.outputs.tag }}](${{ steps.create_release.outputs.url }})
          labels: |
            automated
            registry
