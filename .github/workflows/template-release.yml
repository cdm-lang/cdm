name: Template Release

on:
  push:
    tags:
      # Template tags: cdm-template-{name}-v{version}
      # Example: cdm-template-sql-types-v1.0.0
      - 'cdm-template-*-v*.*.*'

permissions:
  contents: write
  pull-requests: write

# Serialize all template releases to prevent registry update conflicts
concurrency:
  group: template-release
  cancel-in-progress: false

jobs:
  release:
    name: Create Template Release
    runs-on: ubuntu-latest
    outputs:
      template_name: ${{ steps.tag_info.outputs.template_name }}
      version: ${{ steps.tag_info.outputs.version }}
      tag: ${{ steps.tag_info.outputs.tag }}
      description: ${{ steps.metadata.outputs.description }}
      download_url: ${{ steps.metadata.outputs.download_url }}
      checksum: ${{ steps.checksum.outputs.checksum }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract template info from tag
        id: tag_info
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # Extract template name from cdm-template-{name}-v{version} format
          # e.g., cdm-template-sql-types-v1.0.0 -> sql-types
          TEMPLATE_NAME=$(echo $TAG | sed -E 's/^cdm-template-//' | sed -E 's/-v[0-9]+\.[0-9]+\.[0-9]+$//')
          echo "template_name=$TEMPLATE_NAME" >> $GITHUB_OUTPUT

          # Extract version (e.g., 1.0.0 from cdm-template-sql-types-v1.0.0)
          VERSION=$(echo $TAG | sed -E 's/.*-v([0-9]+\.[0-9]+\.[0-9]+)$/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          echo "Releasing template: $TEMPLATE_NAME v$VERSION"

      - name: Verify template exists
        id: verify
        run: |
          TEMPLATE_DIR="templates/${{ steps.tag_info.outputs.template_name }}"

          if [ ! -d "$TEMPLATE_DIR" ]; then
            echo "Error: Template directory not found: $TEMPLATE_DIR"
            exit 1
          fi

          if [ ! -f "$TEMPLATE_DIR/cdm-template.json" ]; then
            echo "Error: cdm-template.json not found in $TEMPLATE_DIR"
            exit 1
          fi

          echo "template_dir=$TEMPLATE_DIR" >> $GITHUB_OUTPUT
          echo "Template verified: $TEMPLATE_DIR"

      - name: Create template archive
        id: archive
        run: |
          TEMPLATE_NAME="${{ steps.tag_info.outputs.template_name }}"
          VERSION="${{ steps.tag_info.outputs.version }}"
          TEMPLATE_DIR="${{ steps.verify.outputs.template_dir }}"
          ARCHIVE_NAME="${TEMPLATE_NAME}-${VERSION}.tar.gz"

          # Create archive from template directory
          tar -czvf "$ARCHIVE_NAME" -C templates "$TEMPLATE_NAME"

          echo "archive_name=$ARCHIVE_NAME" >> $GITHUB_OUTPUT
          echo "Created archive: $ARCHIVE_NAME"
          ls -la "$ARCHIVE_NAME"

      - name: Generate checksum
        id: checksum
        run: |
          ARCHIVE="${{ steps.archive.outputs.archive_name }}"
          CHECKSUM=$(shasum -a 256 "$ARCHIVE" | awk '{print $1}')
          echo "$CHECKSUM" > "${ARCHIVE}.sha256"
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "Checksum: $CHECKSUM"

      - name: Extract metadata
        id: metadata
        run: |
          TEMPLATE_DIR="${{ steps.verify.outputs.template_dir }}"
          ARCHIVE_NAME="${{ steps.archive.outputs.archive_name }}"

          # Read description from cdm-template.json
          DESCRIPTION=$(jq -r '.description // "CDM template"' "$TEMPLATE_DIR/cdm-template.json")

          # Construct download URL
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${{ steps.tag_info.outputs.tag }}/$ARCHIVE_NAME"

          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT

      - name: Create release notes
        run: |
          TEMPLATE_NAME="${{ steps.tag_info.outputs.template_name }}"
          VERSION="${{ steps.tag_info.outputs.version }}"
          DESCRIPTION="${{ steps.metadata.outputs.description }}"

          cat > release_notes.md << EOF
          # $TEMPLATE_NAME v$VERSION

          $DESCRIPTION

          ## Installation

          This template can be used in CDM projects:

          \`\`\`cdm
          import types from "$TEMPLATE_NAME"
          \`\`\`

          To cache locally:

          \`\`\`bash
          cdm template cache $TEMPLATE_NAME
          \`\`\`

          ## Checksum

          SHA256: \`${{ steps.checksum.outputs.checksum }}\`

          ## Files

          - \`${{ steps.archive.outputs.archive_name }}\` - Template archive
          - \`${{ steps.archive.outputs.archive_name }}.sha256\` - SHA256 checksum
          EOF

          echo "Release notes created"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag_info.outputs.tag }}
          name: ${{ steps.tag_info.outputs.template_name }} v${{ steps.tag_info.outputs.version }}
          body_path: release_notes.md
          files: |
            ${{ steps.archive.outputs.archive_name }}
            ${{ steps.archive.outputs.archive_name }}.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-registry:
    name: Update Registry
    needs: release
    uses: ./.github/workflows/update-template-registry.yml
    with:
      template_name: ${{ needs.release.outputs.template_name }}
      version: ${{ needs.release.outputs.version }}
      tag: ${{ needs.release.outputs.tag }}
      description: ${{ needs.release.outputs.description }}
      download_url: ${{ needs.release.outputs.download_url }}
      checksum: ${{ needs.release.outputs.checksum }}
