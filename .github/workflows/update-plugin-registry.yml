name: Update Plugin Registry

on:
  workflow_call:
    inputs:
      plugin_name:
        description: 'Short plugin name (e.g., sql, typescript)'
        required: true
        type: string
      plugin_full_name:
        description: 'Full plugin name (e.g., cdm-plugin-sql)'
        required: true
        type: string
      version:
        description: 'Version without v prefix (e.g., 0.1.0)'
        required: true
        type: string
      description:
        description: 'Plugin description'
        required: true
        type: string
      docs_url:
        description: 'Optional documentation URL'
        required: false
        type: string
        default: ''
      wasm_url:
        description: 'URL to download the WASM file'
        required: true
        type: string
      checksum:
        description: 'SHA256 checksum (without sha256: prefix)'
        required: true
        type: string

jobs:
  update-registry:
    name: Update registry.json
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Update registry.json
        run: |
          echo "Updating registry for plugin: ${{ inputs.plugin_name }}"
          echo "Version: ${{ inputs.version }}"
          echo "URL: ${{ inputs.wasm_url }}"
          echo "Checksum: ${{ inputs.checksum }}"
          echo "Docs: ${{ inputs.docs_url }}"

          # Update registry.json using jq
          jq --arg name "${{ inputs.plugin_name }}" \
             --arg version "${{ inputs.version }}" \
             --arg desc "${{ inputs.description }}" \
             --arg docs "${{ inputs.docs_url }}" \
             --arg url "${{ inputs.wasm_url }}" \
             --arg checksum "sha256:${{ inputs.checksum }}" \
             --arg repo "git:https://github.com/${{ github.repository }}.git" \
             --arg updated "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
             '
             .updated_at = $updated |
             .plugins[$name] = {
               description: $desc,
               repository: $repo,
               official: true,
               versions: ((.plugins[$name].versions // {}) + {
                 ($version): {
                   wasm_url: $url,
                   checksum: $checksum
                 }
               }),
               latest: $version
             } |
             if $docs != "" then .plugins[$name].docs = $docs else . end
             ' registry.json > registry.json.tmp

          mv registry.json.tmp registry.json

          echo "Registry updated successfully"

      - name: Commit and push registry update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add registry.json
          git commit -m "Update registry: ${{ inputs.plugin_full_name }} v${{ inputs.version }}

          Automatically updated registry.json for plugin release.

          - WASM URL: ${{ inputs.wasm_url }}
          - Checksum: sha256:${{ inputs.checksum }}"

          git push origin main
