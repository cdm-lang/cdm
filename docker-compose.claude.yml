version: '3.8'

services:
  claude:
    build:
      context: .
      dockerfile: Dockerfile.claude
    container_name: ${CONTAINER_NAME:-cdm-claude}
    volumes:
      # Mount the entire project
      - .:/workspace
      # Mount git config to preserve user identity
      - ~/.gitconfig:/home/claude/.gitconfig:ro
      # Mount only authentication credentials (shared across all worktrees)
      - ~/.claude.json:/home/claude/.claude.json
    working_dir: ${WORKING_DIR:-/workspace}
    environment:
      # Optional: Set API key if using console.anthropic.com (not needed for claude.ai accounts)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # Disable sandboxing since we're already in a container
      - CLAUDE_DISABLE_SANDBOX=true
      # Store worktree info for shell access
      - WORKTREE_PATH=${WORKTREE_PATH:-}
      # Build in container-local directory to avoid Docker Desktop filesystem issues
      - CARGO_TARGET_DIR=/var/tmp/rust-build
      # Reduce parallel jobs to avoid OOM
      - CARGO_BUILD_JOBS=1
    stdin_open: true
    tty: true
    # Security: Run with limited privileges
    # Remove these if you need more permissions
    security_opt:
      - no-new-privileges:true
    # Increase memory for Rust compilation (wasmtime is memory-intensive)
    mem_limit: 8g
