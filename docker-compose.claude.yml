version: '3.8'

services:
  claude:
    build:
      context: .
      dockerfile: Dockerfile.claude
      args:
        HOST_UID: ${HOST_UID:-501}
        HOST_GID: ${HOST_GID:-20}
    container_name: ${CONTAINER_NAME:-cdm-claude}
    volumes:
      # Mount the entire project
      - .:/workspace
      # Mount git config to preserve user identity
      - ~/.gitconfig:/home/claude/.gitconfig:ro
      # Mount Claude config directory (contains credentials and settings)
      - ~/.claude:/home/claude/.claude
      # Mount only authentication credentials (shared across all worktrees)
      - ~/.claude.json:/home/claude/.claude.json
      # Persistent volume for Rust build cache (avoids filling container disk)
      - cargo-build-cache:/var/tmp/rust-build
    working_dir: ${WORKING_DIR:-/workspace}
    environment:
      # Optional: Set API key if using console.anthropic.com (not needed for claude.ai accounts)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # Disable sandboxing since we're already in a container
      - CLAUDE_DISABLE_SANDBOX=true
      # Store worktree info for shell access
      - WORKTREE_PATH=${WORKTREE_PATH:-}
      # Build in container-local directory to avoid Docker Desktop filesystem issues
      - CARGO_TARGET_DIR=/var/tmp/rust-build
      # Reduce parallel jobs to avoid OOM
      - CARGO_BUILD_JOBS=1
    stdin_open: true
    tty: true
    # Note: no-new-privileges is disabled to allow sudo in entrypoint
    # This is acceptable since the container itself provides isolation
    # Increase memory for Rust compilation (wasmtime is memory-intensive)
    mem_limit: 8g

volumes:
  cargo-build-cache:
