# CDM ts-rest Plugin

Generate type-safe [ts-rest](https://ts-rest.com/) API contracts from your CDM models.

## Overview

The ts-rest plugin generates a type-safe API contract that can be consumed by both server implementations and client applications. The generated contract provides end-to-end type safety for HTTP routes including path parameters, query parameters, request bodies, and responses.

## Dependencies

This plugin requires the following CDM plugins to be configured:

| Plugin | Required | Purpose |
|--------|----------|---------|
| `@typescript` | Yes | Generates named TypeScript interfaces |
| `@zod` | Yes | Generates Zod schemas typed to the interfaces |

The `@ts-rest` plugin must be listed **after** these plugins in the CDM file to ensure their outputs are available.

## Installation

Configure the plugin in your CDM file:

```cdm
@typescript { build_output: "./generated" }
@zod { build_output: "./generated" }
@ts-rest {
  build_output: "./generated",
  base_path: "/api/v1",
  routes: {
    // Route definitions here
  }
}
```

## Quick Start

```cdm
@typescript { build_output: "./generated" }
@zod { build_output: "./generated" }
@ts-rest {
  build_output: "./generated",
  base_path: "/api/v1",
  routes: {
    getUser: {
      method: "GET",
      path: "/users/:id",
      summary: "Get a user by ID",
      pathParams: "GetUserPathParams",
      responses: {
        200: "User",
        404: "NotFoundError"
      }
    },
    listUsers: {
      method: "GET",
      path: "/users",
      summary: "List all users",
      query: "ListUsersQuery",
      responses: {
        200: "User[]"
      }
    },
    createUser: {
      method: "POST",
      path: "/users",
      summary: "Create a new user",
      body: "CreateUserBody",
      responses: {
        201: "User",
        400: "ValidationError"
      }
    },
    deleteUser: {
      method: "DELETE",
      path: "/users/:id",
      pathParams: "GetUserPathParams",
      responses: {
        204: null,
        404: "NotFoundError"
      }
    }
  }
}

// Path/Query parameter models
GetUserPathParams {
  id: string
}

ListUsersQuery {
  limit?: number
  offset?: number
  search?: string
}

// Request body models
CreateUserBody {
  email: string
  name: string
}

// Response models
User {
  id: string
  email: string
  name: string
  createdAt: string
}

NotFoundError {
  code: "NOT_FOUND"
  message: string
}

ValidationError {
  code: "VALIDATION_ERROR"
  message: string
}
```

**Generated Contract (`./generated/contract.ts`):**

```typescript
/**
 * Generated by CDM @ts-rest plugin
 * DO NOT EDIT - changes will be overwritten
 */

import { initContract } from '@ts-rest/core';
import { z } from 'zod';
import {
  CreateUserBodySchema,
  GetUserPathParamsSchema,
  ListUsersQuerySchema,
  NotFoundErrorSchema,
  UserSchema,
  ValidationErrorSchema,
} from './schemas';

const c = initContract();

export const contract = c.router({
  createUser: {
    method: 'POST',
    path: '/api/v1/users',
    body: CreateUserBodySchema,
    responses: {
      201: UserSchema,
      400: ValidationErrorSchema,
    },
    summary: 'Create a new user',
  },

  deleteUser: {
    method: 'DELETE',
    path: '/api/v1/users/:id',
    pathParams: GetUserPathParamsSchema,
    responses: {
      204: z.void(),
      404: NotFoundErrorSchema,
    },
  },

  getUser: {
    method: 'GET',
    path: '/api/v1/users/:id',
    pathParams: GetUserPathParamsSchema,
    responses: {
      200: UserSchema,
      404: NotFoundErrorSchema,
    },
    summary: 'Get a user by ID',
  },

  listUsers: {
    method: 'GET',
    path: '/api/v1/users',
    query: ListUsersQuerySchema,
    responses: {
      200: z.array(UserSchema),
    },
    summary: 'List all users',
  },
});

// Re-export types for convenience
export type {
  CreateUserBody,
  GetUserPathParams,
  ListUsersQuery,
  NotFoundError,
  User,
  ValidationError,
} from './types';
```

## Global Settings

Configure the plugin at import time.

### `build_output` (required)

- **Type:** `string`
- **Description:** Output directory for generated contract file.

```cdm
@ts-rest { build_output: "./generated" }
```

### `base_path`

- **Type:** `string` (optional)
- **Default:** `""`
- **Description:** Base path prefix for all routes.

```cdm
@ts-rest {
  base_path: "/api/v1",
  // Routes with path "/users" become "/api/v1/users"
}
```

### `routes` (required)

- **Type:** `object`
- **Description:** Map of route name to route configuration.

```cdm
@ts-rest {
  routes: {
    routeName: {
      method: "GET",
      path: "/path",
      responses: { 200: "Model" }
    }
  }
}
```

## Route Configuration

Each route in the `routes` object supports the following fields:

### `method` (required)

- **Type:** `"GET" | "POST" | "PUT" | "PATCH" | "DELETE"`
- **Description:** HTTP method for the route.

### `path` (required)

- **Type:** `string`
- **Description:** URL path with parameter placeholders using `:paramName` syntax.

```cdm
path: "/users/:id/posts/:postId"
```

### `summary`

- **Type:** `string` (optional)
- **Description:** Short description of the route (included in generated contract).

### `description`

- **Type:** `string` (optional)
- **Description:** Detailed description of the route.

### `tags`

- **Type:** `string[]` (optional)
- **Description:** Tags for grouping routes.

### `pathParams`

- **Type:** `string` (optional)
- **Description:** Model name for path parameters. Required if `path` contains `:paramName` placeholders.

```cdm
getUser: {
  path: "/users/:id",
  pathParams: "GetUserPathParams",  // Must have "id" field
  // ...
}
```

### `query`

- **Type:** `string` (optional)
- **Description:** Model name for query parameters.

```cdm
listUsers: {
  path: "/users",
  query: "ListUsersQuery",
  // ...
}
```

### `body`

- **Type:** `string` (optional)
- **Description:** Model name for request body.

```cdm
createUser: {
  method: "POST",
  body: "CreateUserBody",
  // ...
}
```

### `responses` (required)

- **Type:** `object`
- **Description:** Map of HTTP status codes to response models.

#### Response Value Types

| Type | Example | Description |
|------|---------|-------------|
| String | `"User"` | Single model response |
| String with `[]` | `"User[]"` | Array response |
| Array | `["ValidationError", "NotFoundError"]` | Union of models |
| `null` | `null` | No response body (e.g., 204) |

```cdm
responses: {
  200: "User",           // Single model
  201: "User",           // Created
  204: null,             // No content
  400: ["ValidationError", "InputError"],  // Union
  404: "NotFoundError"
}

// Array responses
responses: {
  200: "User[]"          // Returns array of Users
}
```

## Validation Rules

The plugin validates your configuration and reports errors/warnings:

### Errors

| Rule | Message |
|------|---------|
| V001 | `build_output` is required |
| V002 | `routes` must contain at least one route |
| V003 | Route is missing required field `method` |
| V004 | Route is missing required field `path` |
| V005 | Route is missing required field `responses` |
| V202 | Path contains parameters but no `pathParams` model specified |
| V301 | Invalid method (must be GET, POST, PUT, PATCH, or DELETE) |
| V401 | Invalid status code (must be between 100 and 599) |
| V501 | Routes have identical method and path |

### Warnings

| Rule | Message |
|------|---------|
| V302 | GET request with body is unusual |
| V303 | DELETE request with body is unusual |
| V304 | POST request without body |
| V305 | PUT request without body |
| V306 | PATCH request without body |
| V402 | Unusual status code |
| V403 | No success response (2xx) defined |
| V502 | Routes have potentially ambiguous paths |

## Usage Examples

### Server Implementation (Fastify)

```typescript
import Fastify from 'fastify';
import { initServer } from '@ts-rest/fastify';
import { contract } from './generated/contract';
import { db } from './db';

const app = Fastify();
const s = initServer();

const router = s.router(contract, {
  getUser: async ({ params }) => {
    const user = await db.users.findById(params.id);

    if (!user) {
      return { status: 404, body: { code: 'NOT_FOUND', message: 'User not found' } };
    }

    return { status: 200, body: user };
  },

  listUsers: async ({ query }) => {
    const users = await db.users.findMany({
      take: query.limit,
      skip: query.offset,
    });

    return { status: 200, body: users };
  },

  createUser: async ({ body }) => {
    const user = await db.users.create(body);
    return { status: 201, body: user };
  },

  deleteUser: async ({ params }) => {
    const deleted = await db.users.delete(params.id);

    if (!deleted) {
      return { status: 404, body: { code: 'NOT_FOUND', message: 'User not found' } };
    }

    return { status: 204, body: undefined };
  },
});

app.register(s.plugin(router));
app.listen({ port: 3000 });
```

### Client Usage

```typescript
import { initClient } from '@ts-rest/core';
import { contract } from './generated/contract';

const client = initClient(contract, {
  baseUrl: 'http://localhost:3000',
  baseHeaders: {
    'Authorization': `Bearer ${token}`,
  },
});

// Fully typed request and response
const { status, body } = await client.getUser({ params: { id: '123' } });

if (status === 200) {
  console.log(body.email); // TypeScript knows body is User
} else if (status === 404) {
  console.log(body.message); // TypeScript knows body is NotFoundError
}
```

### React Query Integration

```typescript
import { initQueryClient } from '@ts-rest/react-query';
import { contract } from './generated/contract';

const api = initQueryClient(contract, {
  baseUrl: 'http://localhost:3000',
});

function UserList() {
  const { data, isLoading } = api.listUsers.useQuery(
    ['users'],
    { query: { limit: 10, offset: 0 } }
  );

  if (isLoading) return <div>Loading...</div>;

  if (data?.status === 200) {
    return (
      <ul>
        {data.body.map(user => (
          <li key={user.id}>{user.name}</li>
        ))}
      </ul>
    );
  }
}
```

## Complete Example

```cdm
@typescript { build_output: "./generated" }
@zod { build_output: "./generated" }
@ts-rest {
  build_output: "./generated",
  base_path: "/api/v1",
  routes: {
    // User endpoints
    getUser: {
      method: "GET",
      path: "/users/:id",
      summary: "Get a user by ID",
      pathParams: "GetUserPathParams",
      responses: {
        200: "User",
        404: "NotFoundError"
      }
    },
    listUsers: {
      method: "GET",
      path: "/users",
      summary: "List all users",
      query: "ListUsersQuery",
      responses: {
        200: "User[]"
      }
    },
    createUser: {
      method: "POST",
      path: "/users",
      summary: "Create a new user",
      body: "CreateUserBody",
      responses: {
        201: "User",
        400: "ValidationError"
      }
    },
    updateUser: {
      method: "PATCH",
      path: "/users/:id",
      summary: "Update a user",
      pathParams: "GetUserPathParams",
      body: "UpdateUserBody",
      responses: {
        200: "User",
        400: "ValidationError",
        404: "NotFoundError"
      }
    },
    deleteUser: {
      method: "DELETE",
      path: "/users/:id",
      summary: "Delete a user",
      pathParams: "GetUserPathParams",
      responses: {
        204: null,
        404: "NotFoundError"
      }
    }
  }
}

// Type aliases
UUID: string {
  @zod { format: "uuid" }
}

Email: string {
  @zod { format: "email", max: 320 }
}

// Path/Query parameter models
GetUserPathParams {
  id: UUID
}

ListUsersQuery {
  limit?: number
  offset?: number
  search?: string
}

// Request body models
CreateUserBody {
  email: Email
  name: string
  role?: "admin" | "user" | "guest"
}

UpdateUserBody {
  email?: Email
  name?: string
  role?: "admin" | "user" | "guest"
}

// Response models
User {
  id: UUID
  email: Email
  name: string
  role: "admin" | "user" | "guest"
  createdAt: string
  updatedAt: string
}

// Error models
NotFoundError {
  code: "NOT_FOUND"
  message: string
}

ValidationError {
  code: "VALIDATION_ERROR"
  message: string
  errors: FieldError[]
}

FieldError {
  field: string
  message: string
}
```

## Output Files

The plugin generates a single file:

- **`{build_output}/contract.ts`** - ts-rest contract with all routes

This file imports from:
- `./schemas` - Zod schemas (generated by `@zod` plugin)
- `./types` - TypeScript types (generated by `@typescript` plugin)

## CLI Commands

```bash
# Validate configuration
cdm validate schema.cdm

# Generate contract
cdm build schema.cdm
```

---

## Development

### Building

```bash
# Build the plugin (release mode)
make build

# Build in debug mode (faster compilation)
make build-debug

# See all available commands
make help
```

### Testing

```bash
# Run all tests
make test

# Run unit tests only
make test-unit
```

### Local Testing

Use this plugin from any CDM file with a relative path:

```cdm
@ts-rest from "./path/to/cdm-plugin-ts-rest" {
  build_output: "./generated",
  routes: { /* ... */ }
}
```

## License

See the main CDM repository for license information.
